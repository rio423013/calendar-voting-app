<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äºˆå®šé¸æŠã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    h2 { margin-bottom: 5px; }
    h3 { margin-top: 0; }
    table { margin: 0 auto; border-collapse: collapse; width: 80%; max-width: 600px; }
    th, td { padding: 10px; border: 1px solid #ccc; cursor: pointer; }
    th.sunday, td.sunday { color: red; }
    th.saturday, td.saturday { color: blue; }
    .rank1 { background-color: #28a745; color: white; }
    .rank2 { background-color: #ffc107; }
    .rank3 { background-color: #dc3545; color: white; }
    .ranking-item {
    font-size: 1.2em;
    margin: 10px 0;
    font-weight: bold;
    }
    td {
      vertical-align: top;
      width: 14.28%; /* 7åˆ—å‡ç­‰ */
      height: 100px;
      position: relative;
      padding: 6px;
      box-sizing: border-box;
    }
    
    .vote-info {
      font-size: 0.75em;
      margin-top: 6px;
      background-color: #f0f0f0;
      border-radius: 4px;
      padding: 4px 6px;
      line-height: 1.5;
      display: block;
      text-align: left;
      min-height: 40px; /* æƒ…å ±æ¬„ã®é«˜ã•ã‚’ç¢ºä¿ */
    }
    .choice1 {
      background-color: #cce5ff; /* æ°´è‰²ï¼šç¬¬1å¸Œæœ› */
    }
    .choice2 {
      background-color: #d4edda; /* ç·‘ï¼šç¬¬2å¸Œæœ› */
    }
    .choice3 {
      background-color: #fff3cd; /* é»„è‰²ï¼šç¬¬3å¸Œæœ› */
    }
    .vote-info div {
    white-space: nowrap;
  }
  </style>
</head>
<body>
  <h2>å¸Œæœ›æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæœ€å¤§3æ—¥ï¼‰</h2>
  <h3 id="month-label"></h3>
  <table id="calendar"></table>

  <div id="user-section" style="margin-top:20px;">
    <input type="text" id="username" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" />
  </div>

  <div id="choices-section" style="margin-top:20px;">
    <p>ç¬¬ï¼‘å¸Œæœ›æ—¥ï¼š<span id="choice1">-</span></p>
    <p>ç¬¬ï¼’å¸Œæœ›æ—¥ï¼š<span id="choice2">-</span></p>
    <p>ç¬¬ï¼“å¸Œæœ›æ—¥ï¼š<span id="choice3">-</span></p>
    <button id="save-btn">ä¿å­˜ã™ã‚‹</button>
    <button id="clear-btn" style="margin-left:10px;">è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
  </div>

  <div style="margin-top:30px;">
    <button id="ranking-btn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
  </div>

  <div id="ranking-section" style="display:none; margin-top:20px;">
    <h3>å¸Œæœ›æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <div id="ranking"></div>
    <button id="back-btn">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      serverTimestamp,
      deleteDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDherYYbpXW20ADYD_9ve52sLjXqpbppvU",
      authDomain: "calendar-voting.firebaseapp.com",
      projectId: "calendar-voting",
      storageBucket: "calendar-voting.firebasestorage.app",
      messagingSenderId: "1062818293526",
      appId: "1:1062818293526:web:3597105b47d62f4606d237"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    let currentUserId = null;

    signInAnonymously(auth)
      .then(() => console.log("âœ… åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"))
      .catch((error) => console.error("âŒ åŒ¿åãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", error));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:", currentUserId);
      }
    });

    const selectedDates = [];
    let saved = false;
    const currentYear = 2025;
    const currentMonth = 7;

    function updateDisplay() {
      document.getElementById("choice1").textContent = selectedDates[0] ?? "-";
      document.getElementById("choice2").textContent = selectedDates[1] ?? "-";
      document.getElementById("choice3").textContent = selectedDates[2] ?? "-";
    }

    async function createCalendar(year, month) {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";
      const voteCounts = await getVoteCounts(); // ğŸ” æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿å–å¾—
      const monthLabel = document.getElementById("month-label");
      const monthNames = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];
      monthLabel.textContent = `${year}å¹´ ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const dayNames = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const headerRow = document.createElement("tr");
      dayNames.forEach((day, i) => {
        const th = document.createElement("th");
        th.textContent = day;
        if (i === 0) th.className = "sunday";
        if (i === 6) th.className = "saturday";
        headerRow.appendChild(th);
      });
      calendar.appendChild(headerRow);

      let date = 1;
      for (let row = 0; row < 6 && date <= daysInMonth; row++) {
        const tr = document.createElement("tr");
        for (let col = 0; col < 7; col++) {
          const td = document.createElement("td");
          if (row === 0 && col < firstDay) {
            td.textContent = "";
          } else if (date <= daysInMonth) {
            td.textContent = date;

            const vote = voteCounts[String(date)];
            const infoDiv = document.createElement("div");
            infoDiv.className = "vote-info";

            if (vote) {
              const info = [];
              if (vote.rank1 > 0) info.push(`<div>ç¬¬1å¸Œæœ› ${vote.rank1}äºº</div>`);
              if (vote.rank2 > 0) info.push(`<div>ç¬¬2å¸Œæœ› ${vote.rank2}äºº</div>`);
              if (vote.rank3 > 0) info.push(`<div>ç¬¬3å¸Œæœ› ${vote.rank3}äºº</div>`);
              infoDiv.innerHTML = info.join("");
            } else {
              infoDiv.innerHTML = ""; // ç©ºã§ã‚‚è¡¨ç¤ºã—ã¦é«˜ã•ã‚’ç¢ºä¿
            }
            td.appendChild(infoDiv);
            td.id = `day-${date}`;
            td.onclick = ((d) => () => handleDateClick(d))(date);
            if (col === 0) td.classList.add("sunday");
            if (col === 6) td.classList.add("saturday");
            date++;
          }
          tr.appendChild(td)
        }
        calendar.appendChild(tr);
      }
    }

    function handleDateClick(day) {
      if (saved) return;

      const index = selectedDates.indexOf(day);
      if (index !== -1) {
        selectedDates.splice(index, 1);
      } else if (selectedDates.length < 3) {
        selectedDates.push(day);
      }

      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      for (let i = 1; i <= daysInMonth; i++) {
        const td = document.getElementById(`day-${i}`);
        if (td) {
          td.classList.remove("choice1", "choice2", "choice3");
        }
      }

      selectedDates.forEach((d, i) => {
        const td = document.getElementById(`day-${d}`);
        if (td) {
          td.classList.add(`choice${i + 1}`);
        }
      });

      updateDisplay();
    }

    async function saveChoices() {
      if (!currentUserId) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ã¾ã§å°‘ã—å¾…ã£ã¦ãã ã•ã„");
        return;
      }

      const username = document.getElementById("username").value.trim();
      if (!username) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      if (selectedDates.length === 0) {
        alert("æœ€ä½1ã¤ã¯å¸Œæœ›æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
        return;
      }

      try {
        const votesRef = collection(db, "votes");
        for (let i = 0; i < selectedDates.length; i++) {
          await addDoc(votesRef, {
            day: selectedDates[i],
            rank: i + 1,
            points: 3 - i,
            timestamp: serverTimestamp(),
            userId: currentUserId,
            username: username
          });
        }
        saved = true;
        alert("å¸Œæœ›æ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ ğŸ‰");
      } catch (e) {
        console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ ğŸ˜¢");
      }
    }

    async function clearVotes() {
      try {
        const username = document.getElementById("username").value.trim();
        if (!username) {
          alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        const q = query(collection(db, "votes"), where("username", "==", username));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          alert("ãã®åå‰ã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
          return;
        }

        for (const doc of snapshot.docs) {
          await deleteDoc(doc.ref);
        }

        alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ ğŸ§¹`);
        saved = false;

        await createCalendar(currentYear, currentMonth); // â† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»
      } catch (e) {
        console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
        alert("ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ ğŸ˜¢");
      }
    }

    async function fetchVotes() {
      const querySnapshot = await getDocs(collection(db, "votes"));
      const scores = {};
      querySnapshot.forEach(doc => {
        const { day, points } = doc.data();
        scores[day] = (scores[day] || 0) + points;
      });
      return scores;
    }

    async function getVoteCounts() {
      const snapshot = await getDocs(collection(db, "votes"));
      const counts = {}; // { day: { rank1: x, rank2: y, rank3: z } }
      
      snapshot.forEach(doc => {
        const { day, rank } = doc.data();
        if (!counts[day]) counts[day] = { rank1: 0, rank2: 0, rank3: 0 };
        counts[day][`rank${rank}`]++;
      });
      
      return counts;
    }
    
    // ğŸ”½ ã“ã“ã«è¿½åŠ ï¼
    async function fetchUserList() {
      const snapshot = await getDocs(collection(db, "votes"));
      const userSet = new Set();

      snapshot.forEach(doc => {
        const { username } = doc.data();
        if (username) {
          userSet.add(username);
        }
      });
      
      return [...userSet];
    }

    function showRanking(scores) {
      const rankingDiv = document.getElementById("ranking");
      rankingDiv.innerHTML = "";

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
      const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
      const grouped = {};
      sorted.forEach(([day, score]) => {
        if (!grouped[score]) grouped[score] = [];
        grouped[score].push(day);
      });

      const icons = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];
      let rank = 1;

      for (const score of Object.keys(grouped).sort((a, b) => b - a)) {
        if (rank > 3) break;
        const days = grouped[score];
        const icon = icons[rank - 1] || `ğŸ…${rank}ä½`;

        const item = document.createElement("div");
        item.className = "ranking-item";
        item.textContent = `${icon} ${days.map(d => `${d}æ—¥`).join("ã€")}`;
        rankingDiv.appendChild(item);

        rank++;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
      fetchUserList().then(usernames => {
        const userListTitle = document.createElement("h4");
        userListTitle.textContent = "æŠ•ç¥¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§";
        userListTitle.style.marginTop = "20px";

        const userList = document.createElement("ul");
        usernames.forEach(name => {
          const li = document.createElement("li");
          li.textContent = name;
          userList.appendChild(li);
        });

        rankingDiv.appendChild(userListTitle);
        rankingDiv.appendChild(userList);
      });
    }

    async function toggleRanking() {
      const calendarSection = document.querySelector("table");
      const choicesSection = document.getElementById("choices-section");
      const rankingSection = document.getElementById("ranking-section");
      const isRankingVisible = rankingSection.style.display === "block";

      rankingSection.style.display = isRankingVisible ? "none" : "block";
      calendarSection.style.display = isRankingVisible ? "table" : "none";
      choicesSection.style.display = isRankingVisible ? "block" : "none";

      if (!isRankingVisible) {
        const scores = await fetchVotes();
        showRanking(scores);
      }
    }

    window.onload = () => {
      createCalendar(currentYear, currentMonth);
      updateDisplay();
      document.getElementById("save-btn").addEventListener("click", saveChoices);
      document.getElementById("clear-btn").addEventListener("click", clearVotes);
      document.getElementById("ranking-btn").addEventListener("click", toggleRanking);
      document.getElementById("back-btn").addEventListener("click", toggleRanking);
    };
  </script>
</body>
</html>
