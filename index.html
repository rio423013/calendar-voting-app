<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>予定選択カレンダー</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    h2 { margin-bottom: 5px; }
    h3 { margin-top: 0; }
    table { margin: 0 auto; border-collapse: collapse; width: 80%; max-width: 600px; }
    th, td { padding: 10px; border: 1px solid #ccc; cursor: pointer; }
    th.sunday, td.sunday { color: red; }
    th.saturday, td.saturday { color: blue; }
    .rank1 { background-color: #28a745; color: white; }
    .rank2 { background-color: #ffc107; }
    .rank3 { background-color: #dc3545; color: white; }
  </style>
</head>
<body>
  <h2>希望日を選んでください（最大3日）</h2>
  <h3 id="month-label"></h3>
  <table id="calendar"></table>

  <div id="user-section" style="margin-top:20px;">
    <input type="text" id="username" placeholder="あなたの名前を入力" />
  </div>

  <div id="choices-section" style="margin-top:20px;">
    <p>第１希望日：<span id="choice1">-</span></p>
    <p>第２希望日：<span id="choice2">-</span></p>
    <p>第３希望日：<span id="choice3">-</span></p>
    <button id="save-btn">保存する</button>
    <button id="clear-btn" style="margin-left:10px;">自分のデータを削除</button>
  </div>

  <div style="margin-top:30px;">
    <button id="ranking-btn">ランキングを見る</button>
  </div>

  <div id="ranking-section" style="display:none; margin-top:20px;">
    <h3>希望日ランキング</h3>
    <div id="ranking"></div>
    <button id="back-btn">カレンダーに戻る</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      serverTimestamp,
      deleteDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDherYYbpXW20ADYD_9ve52sLjXqpbppvU",
      authDomain: "calendar-voting.firebaseapp.com",
      projectId: "calendar-voting",
      storageBucket: "calendar-voting.firebasestorage.app",
      messagingSenderId: "1062818293526",
      appId: "1:1062818293526:web:3597105b47d62f4606d237"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    let currentUserId = null;

    signInAnonymously(auth)
      .then(() => console.log("✅ 匿名ログイン成功"))
      .catch((error) => console.error("❌ 匿名ログイン失敗:", error));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("ログインユーザーID:", currentUserId);
      }
    });

    const selectedDates = [];
    let saved = false;
    const currentYear = 2025;
    const currentMonth = 7;

    function updateDisplay() {
      document.getElementById("choice1").textContent = selectedDates[0] ?? "-";
      document.getElementById("choice2").textContent = selectedDates[1] ?? "-";
      document.getElementById("choice3").textContent = selectedDates[2] ?? "-";
    }

    function createCalendar(year, month) {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";
      const monthLabel = document.getElementById("month-label");
      const monthNames = ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];
      monthLabel.textContent = `${year}年 ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
      const headerRow = document.createElement("tr");
      dayNames.forEach((day, i) => {
        const th = document.createElement("th");
        th.textContent = day;
        if (i === 0) th.className = "sunday";
        if (i === 6) th.className = "saturday";
        headerRow.appendChild(th);
      });
      calendar.appendChild(headerRow);

      let date = 1;
      for (let row = 0; row < 6 && date <= daysInMonth; row++) {
        const tr = document.createElement("tr");
        for (let col = 0; col < 7; col++) {
          const td = document.createElement("td");
          if (row === 0 && col < firstDay) {
            td.textContent = "";
          } else if (date <= daysInMonth) {
            td.textContent = date;
            td.id = `day-${date}`;
            td.onclick = ((d) => () => handleDateClick(d))(date);
            if (col === 0) td.classList.add("sunday");
            if (col === 6) td.classList.add("saturday");
            date++;
          }
          tr.appendChild(td);
        }
        calendar.appendChild(tr);
      }
    }

    function handleDateClick(day) {
      if (saved) return;
      const index = selectedDates.indexOf(day);
      if (index !== -1) {
        selectedDates.splice(index, 1);
      } else if (selectedDates.length < 3) {
        selectedDates.push(day);
      }

      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      for (let i = 1; i <= daysInMonth; i++) {
        const td = document.getElementById(`day-${i}`);
        if (td) td.classList.remove("rank1", "rank2", "rank3");
      }

      selectedDates.forEach((d, i) => {
        const td = document.getElementById(`day-${d}`);
        if (td) td.classList.add(`rank${i + 1}`);
      });

      updateDisplay();
    }

    async function saveChoices() {
      if (!currentUserId) {
        alert("ログインが完了するまで少し待ってください");
        return;
      }

      const username = document.getElementById("username").value.trim();
      if (!username) {
        alert("名前を入力してください");
        return;
      }

      if (selectedDates.length === 0) {
        alert("最低1つは希望日を選んでください！");
        return;
      }

      try {
        const votesRef = collection(db, "votes");
        for (let i = 0; i < selectedDates.length; i++) {
          await addDoc(votesRef, {
            day: selectedDates[i],
            rank: i + 1,
            points: 3 - i,
            timestamp: serverTimestamp(),
            userId: currentUserId,
            username: username
          });
        }
        saved = true;
        alert("希望日を保存しました 🎉");
      } catch (e) {
        console.error("保存エラー:", e);
        alert("保存に失敗しました 😢");
      }
    }

    async function clearVotes() {
      try {
        if (!currentUserId) {
          alert("ログインしていません");
          return;
        }

        const q = query(collection(db, "votes"), where("userId", "==", currentUserId));
        const snapshot = await getDocs(q);
        for (const doc of snapshot.docs) {
          await deleteDoc(doc.ref);
        }

        alert("自分のデータを削除しました 🧹");
        saved = false;
            } catch (e) {
        console.error("削除エラー:", e);
        alert("データの削除に失敗しました 😢");
      }
    }

    async function fetchVotes() {
      const querySnapshot = await getDocs(collection(db, "votes"));
      const scores = {};
      querySnapshot.forEach(doc => {
        const { day, points } = doc.data();
        scores[day] = (scores[day] || 0) + points;
      });
      return scores;
    }

    function showRanking(scores) {
      const rankingDiv = document.getElementById("ranking");
      rankingDiv.innerHTML = "";
      const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
      sorted.forEach(([day, score]) => {
        const item = document.createElement("div");
        item.textContent = `${day}日: ${score}ポイント`;
        rankingDiv.appendChild(item);
      });
    }

    async function toggleRanking() {
      const calendarSection = document.querySelector("table");
      const choicesSection = document.getElementById("choices-section");
      const rankingSection = document.getElementById("ranking-section");
      const isRankingVisible = rankingSection.style.display === "block";

      rankingSection.style.display = isRankingVisible ? "none" : "block";
      calendarSection.style.display = isRankingVisible ? "table" : "none";
      choicesSection.style.display = isRankingVisible ? "block" : "none";

      if (!isRankingVisible) {
        const scores = await fetchVotes();
        showRanking(scores);
      }
    }

    window.onload = () => {
      createCalendar(currentYear, currentMonth);
      updateDisplay();
      document.getElementById("save-btn").addEventListener("click", saveChoices);
      document.getElementById("clear-btn").addEventListener("click", clearVotes);
      document.getElementById("ranking-btn").addEventListener("click", toggleRanking);
      document.getElementById("back-btn").addEventListener("click", toggleRanking);
    };
  </script>
</body>
</html>
